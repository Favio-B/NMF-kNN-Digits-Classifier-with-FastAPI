<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>NMF + kNN Digits Classifier with FastAPI</title>
    <style>
      :root{
        --bg: #0f172a;         /* slate-900 */
        --panel: #111827;      /* gray-900 */
        --card: #0b1224;       /* custom */
        --muted: #94a3b8;      /* slate-400 */
        --text: #e5e7eb;       /* gray-200 */
        --accent: #38bdf8;     /* sky-400 */
        --accent-2: #a78bfa;   /* violet-400 */
        --success: #22c55e;    /* green-500 */
        --warn: #f59e0b;       /* amber-500 */
        --danger: #ef4444;     /* red-500 */
        --border: #1f2a44;
        --shadow: 0 10px 30px rgba(0,0,0,.25);
      }
      @media (prefers-color-scheme: light){
        :root{ --bg:#f8fafc; --panel:#ffffff; --card:#ffffff; --text:#0f172a; --muted:#475569; --border:#e2e8f0; }
      }

      *{ box-sizing: border-box; }
      body{
        margin:0; background: radial-gradient(1200px 500px at 10% -10%, rgba(56,189,248,.18), transparent),
                          radial-gradient(1000px 480px at 110% -20%, rgba(167,139,250,.14), transparent),
                          var(--bg);
        color: var(--text);
        font: 14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      }
      header{
        position: sticky; top:0; z-index: 10;
        background: linear-gradient(90deg, rgba(56,189,248,.08), rgba(167,139,250,.08));
        border-bottom: 1px solid var(--border);
        backdrop-filter: blur(6px);
      }
      .wrap{ max-width: 980px; margin: 0 auto; padding: 18px 20px; }
      .brand{ display:flex; align-items:center; gap:12px; }
      .logo{
        width: 36px; height: 36px; border-radius: 10px;
        background: conic-gradient(from 210deg, var(--accent), var(--accent-2));
        box-shadow: var(--shadow);
      }
      h1{ font-size: 18px; margin:0; letter-spacing: .3px; }

      main{ max-width: 980px; margin: 28px auto; padding: 0 20px; display: grid; grid-template-columns: 1fr; gap: 18px; }
      .card{ background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 18px; box-shadow: var(--shadow); }
      .title{ margin:0 0 10px; font-size: 16px; color: var(--muted); }
      .row{ display:flex; flex-wrap: wrap; gap:12px; align-items:center; margin: 10px 0; }

      .pills{ display:flex; gap:8px; background: var(--panel); border:1px solid var(--border); padding:6px; border-radius: 12px; }
      .pill{ border:none; background: transparent; color: var(--muted); padding:8px 12px; border-radius: 8px; cursor:pointer; transition:.15s; }
      .pill.active{ background: linear-gradient(90deg, rgba(56,189,248,.18), rgba(167,139,250,.18)); color: var(--text); }

      .drop{
        border: 2px dashed var(--border); border-radius: 12px; padding: 16px; background: var(--panel);
        display:flex; gap:12px; align-items:center; justify-content: space-between; flex-wrap:wrap;
      }
      .drop.highlight{ border-color: var(--accent); background: rgba(56,189,248,.06); }
      .file-ctrls{ display:flex; gap:10px; align-items:center; }
      input[type=file]{ display:none; }
      .btn, button{
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        color: #001018; border:none; padding: 10px 14px; border-radius: 10px; cursor:pointer; font-weight:600;
        box-shadow: var(--shadow);
      }
      .btn.secondary{ background: transparent; color: var(--text); border:1px solid var(--border); box-shadow:none; }

      .preview{ max-width: 220px; max-height: 220px; border-radius: 10px; border:1px solid var(--border); object-fit: contain; background:#0002; }
      .meta{ color: var(--muted); font-size: 12px; }

      .headline{ font-size: 28px; font-weight: 800; letter-spacing: .5px; margin:6px 0 2px; }
      .sub{ color: var(--muted); margin:0 0 8px; }
      .grid-wrap{ display:flex; gap:14px; align-items:flex-start; flex-wrap:wrap; }
      canvas{ border:1px solid var(--border); border-radius: 8px; background: #0a0f1e; }

      .top5{ width:100%; border-collapse: collapse; }
      .top5 th,.top5 td{ border-bottom:1px solid var(--border); padding:8px; text-align:left; }
      .bar{ height: 8px; border-radius: 6px; background: rgba(56,189,248,.25); position: relative; }
      .bar > span{ position:absolute; inset:0; width:0; background: linear-gradient(90deg, var(--accent), var(--accent-2)); border-radius: 6px; }

      .result-raw{ white-space: pre-wrap; background: #00000018; border: 1px solid var(--border); padding: 12px; border-radius: 10px; margin-top: 10px; }
    </style>
  </head>
  <body>
    <header>
      <div class="wrap brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>NMF + kNN Digits Classifier with FastAPI</h1>
      </div>
    </header>

    <main>
      <section class="card">
        <h2 class="title">Selecciona el modelo</h2>
        <div class="pills" role="tablist" aria-label="modelos">
          <button class="pill active" id="pill-digits" aria-selected="true">Dígitos (NMF + kNN)</button>
          <button class="pill" id="pill-imagenet" aria-selected="false">Objetos (ImageNet)</button>
        </div>

        <h2 class="title" style="margin-top:16px">Sube tu imagen</h2>
        <div id="drop" class="drop">
          <div>
            <div class="meta">Arrastra y suelta aquí o selecciona un archivo</div>
            <div class="row file-ctrls">
              <label class="btn secondary" for="image">Elegir archivo</label>
              <span id="fname" class="meta">Ningún archivo seleccionado</span>
              <input id="image" type="file" accept="image/*" />
            </div>
          </div>
          <img id="preview" class="preview" alt="preview" />
        </div>

        <div class="row" style="margin-top:14px">
          <button id="send"><span id="sendtxt">Enviar</span></button>
          <button id="clear" class="btn secondary">Limpiar</button>
        </div>
      </section>

      <section class="card">
        <h2 class="title">Resultado</h2>
        <div class="headline" id="headline">—</div>
        <p class="sub" id="subtitle">Sube una imagen para ver la predicción.</p>

        <div class="grid-wrap" id="digitsWrap" style="display:none">
          <canvas id="grid" width="160" height="160"></canvas>
          <div class="meta">Vista 8×8 procesada por el modelo de dígitos.</div>
        </div>

        <div id="top5Wrap" style="display:none; margin-top:8px">
          <table class="top5" id="top5"></table>
        </div>

        <div class="result-raw" id="out">(aquí aparecerá la respuesta JSON)</div>
      </section>
    </main>

    <script>
      const pillDigits = document.getElementById('pill-digits');
      const pillImagenet = document.getElementById('pill-imagenet');
      const imgInput = document.getElementById('image');
      const preview = document.getElementById('preview');
      const out = document.getElementById('out');
      const sendBtn = document.getElementById('send');
      const sendTxt = document.getElementById('sendtxt');
      const clearBtn = document.getElementById('clear');
      const drop = document.getElementById('drop');
      const fname = document.getElementById('fname');
      const headline = document.getElementById('headline');
      const subtitle = document.getElementById('subtitle');
      const grid = document.getElementById('grid');
      const digitsWrap = document.getElementById('digitsWrap');
      const top5Wrap = document.getElementById('top5Wrap');
      const top5Tbl = document.getElementById('top5');

      let model = 'digits';
      function setModel(m){
        model = m;
        if(m==='digits'){
          pillDigits.classList.add('active'); pillDigits.setAttribute('aria-selected','true');
          pillImagenet.classList.remove('active'); pillImagenet.setAttribute('aria-selected','false');
          subtitle.textContent = 'Usando modelo de dígitos 8×8 (NMF + kNN).';
        }else{
          pillImagenet.classList.add('active'); pillImagenet.setAttribute('aria-selected','true');
          pillDigits.classList.remove('active'); pillDigits.setAttribute('aria-selected','false');
          subtitle.textContent = 'Usando clasificador general (ImageNet).';
        }
      }
      pillDigits.addEventListener('click', ()=> setModel('digits'));
      pillImagenet.addEventListener('click', ()=> setModel('imagenet'));

      function updPreview(file){
        if(!file){ preview.src=''; fname.textContent='Ningún archivo seleccionado'; return; }
        const url = URL.createObjectURL(file);
        preview.src = url; fname.textContent = file.name + ` (${Math.round(file.size/1024)} KB)`;
      }
      imgInput.addEventListener('change', () => updPreview(imgInput.files && imgInput.files[0]));

      // Drag & drop
      ;['dragenter','dragover','dragleave','drop'].forEach(ev => drop.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); }));
      ;['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, () => drop.classList.add('highlight')));
      ;['dragleave','drop'].forEach(ev => drop.addEventListener(ev, () => drop.classList.remove('highlight')));
      drop.addEventListener('drop', e => { const f = e.dataTransfer.files && e.dataTransfer.files[0]; if(f){ imgInput.files = e.dataTransfer.files; updPreview(f); } });

      function drawDigitsGrid(arr){
        if(!grid) return; const ctx = grid.getContext('2d'); const N=8; const S=20; // 8*20=160
        for(let i=0;i<N;i++){
          for(let j=0;j<N;j++){
            const v = Math.max(0, Math.min(1, arr[i][j]));
            const g = Math.round(v*255);
            ctx.fillStyle = `rgb(${g},${g},${g})`;
            ctx.fillRect(j*S, i*S, S, S);
          }
        }
        ctx.strokeStyle = 'rgba(255,255,255,.08)';
        for(let k=0;k<=N;k++){ ctx.beginPath(); ctx.moveTo(0, k*S+.5); ctx.lineTo(N*S, k*S+.5); ctx.stroke(); }
        for(let k=0;k<=N;k++){ ctx.beginPath(); ctx.moveTo(k*S+.5, 0); ctx.lineTo(k*S+.5, N*S); ctx.stroke(); }
      }

      function setBusy(b){ sendBtn.disabled = b; sendTxt.textContent = b ? 'Procesando…' : 'Enviar'; }

      function renderImagenetTop5(list){
        top5Tbl.innerHTML = '<tr><th>Etiqueta</th><th style="width:60%">Probabilidad</th></tr>';
        list.forEach(item => {
          const tr = document.createElement('tr');
          const tdL = document.createElement('td'); tdL.textContent = item.label;
          const tdB = document.createElement('td');
          const bar = document.createElement('div'); bar.className='bar';
          const span = document.createElement('span'); span.style.width = Math.round(item.prob*100)+'%';
          bar.appendChild(span); tdB.appendChild(bar);
          tr.appendChild(tdL); tr.appendChild(tdB); top5Tbl.appendChild(tr);
        });
      }

      async function send(){
        const file = imgInput.files && imgInput.files[0];
        if(!file){ out.textContent='Selecciona una imagen primero.'; return; }
        const form = new FormData(); form.append('image', file, file.name);
        const endpoint = model === 'imagenet' ? '/predict_imagenet' : '/predict';
        setBusy(true); out.textContent='Enviando…'; headline.textContent='—'; top5Wrap.style.display='none'; digitsWrap.style.display='none';
        try{
          const res = await fetch(endpoint, { method:'POST', body: form });
          const txt = await res.text();
          let json = null; try { json = JSON.parse(txt); } catch{ out.textContent=`Respuesta no JSON (status ${res.status})\n`+txt; return; }
          out.textContent = JSON.stringify(json, null, 2);

          if(model==='digits'){
            headline.textContent = `Predicción: ${json.pred}`;
            subtitle.textContent = 'Modelo de dígitos (NMF + kNN)';
            if(json.seen_8x8){ digitsWrap.style.display='flex'; drawDigitsGrid(json.seen_8x8); }
          }else{
            const top1 = json.top1 || {}; const p = typeof top1.prob==='number' ? (top1.prob*100).toFixed(1)+'%' : '';
            headline.textContent = top1.label ? `Top-1: ${top1.label} (${p})` : 'Predicción lista';
            subtitle.textContent = 'Clasificador de objetos (ImageNet)';
            if(Array.isArray(json.top5)){ top5Wrap.style.display='block'; renderImagenetTop5(json.top5); }
          }
        }catch(err){ out.textContent = 'Error: '+err; }
        finally{ setBusy(false); }
      }

      sendBtn.addEventListener('click', send);
      clearBtn.addEventListener('click', () => { imgInput.value=''; preview.src=''; fname.textContent='Ningún archivo seleccionado'; out.textContent='(aquí aparecerá la respuesta JSON)'; headline.textContent='—'; digitsWrap.style.display='none'; top5Wrap.style.display='none'; });
    </script>
  </body>
  </html>
